# Mobile: Internationalization (i18n)

## Stack

- **Library:** i18next + react-i18next
- **Storage:** MMKV for language persistence
- **Detector:** Custom MMKV-based detector
- **Location:** `mobile/src/shared/i18n/`

## Configuration

**File:** `mobile/src/shared/i18n/config.ts`

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as Localization from 'expo-localization';
import { mmkvLanguageDetector } from './storage';

export const SUPPORTED_LANGUAGES = ['en', 'es'] as const;
export type SupportedLanguage = (typeof SUPPORTED_LANGUAGES)[number];

// Import translation files
import enCommon from '../locales/en/common.json';
import esCommon from '../locales/es/common.json';
import enDashboard from '../locales/en/dashboard.json';
import esDashboard from '../locales/es/dashboard.json';
import enSettings from '../locales/en/settings.json';
import esSettings from '../locales/es/settings.json';

const resources = {
  en: {
    common: enCommon,
    dashboard: enDashboard,
    settings: enSettings,
  },
  es: {
    common: esCommon,
    dashboard: esDashboard,
    settings: esSettings,
  },
};

i18n
  .use(mmkvLanguageDetector)
  .use(initReactI18next)
  .init({
    resources,
    supportedLngs: SUPPORTED_LANGUAGES,
    fallbackLng: 'en',
    interpolation: {
      escapeValue: false,
    },
    react: {
      useSuspense: false,
    },
  });

export default i18n;
```

## Storage Detector

**File:** `mobile/src/shared/i18n/storage.ts`

```typescript
import { MMKV } from 'react-native-mmkv';
import { STORAGE_KEYS } from '@/constants';
import type { LanguageDetectorModule } from 'i18next';

const storage = new MMKV({
  id: 'i18n-storage',
});

export const mmkvLanguageDetector: LanguageDetectorModule = {
  type: 'languageDetector',
  detect: () => {
    // Check stored preference
    const storedLang = storage.getString(STORAGE_KEYS.LANGUAGE);

    if (storedLang) {
      return storedLang;
    }

    // Fall back to device locale
    return 'en';
  },
  cacheUserLanguage: (lng: string) => {
    storage.set(STORAGE_KEYS.LANGUAGE, lng);
  },
};
```

## Type Definitions

**File:** `mobile/src/shared/i18n/types.ts`

```typescript
import type enCommon from '../locales/en/common.json';
import type enDashboard from '../locales/en/dashboard.json';
import type enSettings from '../locales/en/settings.json';

type Translations = typeof enCommon & typeof enDashboard & typeof enSettings;

declare module 'i18next' {
  interface CustomTypeOptions {
    defaultNS: typeof common;
    resources: {
      common: typeof enCommon;
      dashboard: typeof enDashboard;
      settings: typeof enSettings;
    };
  }
}
```

## Translation Files

**File:** `mobile/src/shared/locales/en/common.json`

```json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "loading": "Loading...",
    "error": "An error occurred",
    "success": "Success",
    "confirm": "Confirm",
    "back": "Back",
    "next": "Next",
    "submit": "Submit",
    "close": "Close"
  },
  "auth": {
    "login": "Login",
    "logout": "Logout",
    "register": "Register",
    "email": "Email",
    "password": "Password",
    "forgotPassword": "Forgot password?",
    "rememberMe": "Remember me",
    "loginSuccess": "Logged in successfully",
    "loginError": "Invalid credentials",
    "dontHaveAccount": "Don't have an account?",
    "alreadyHaveAccount": "Already have an account?"
  },
  "validation": {
    "required": "This field is required",
    "emailInvalid": "Invalid email address",
    "passwordMin": "Password must be at least {min} characters",
    "passwordMatch": "Passwords must match"
  }
}
```

**File:** `mobile/src/shared/locales/es/common.json`

```json
{
  "common": {
    "save": "Guardar",
    "cancel": "Cancelar",
    "delete": "Eliminar",
    "edit": "Editar",
    "loading": "Cargando...",
    "error": "Ocurrió un error",
    "success": "Éxito",
    "confirm": "Confirmar",
    "back": "Atrás",
    "next": "Siguiente",
    "submit": "Enviar",
    "close": "Cerrar"
  },
  "auth": {
    "login": "Iniciar sesión",
    "logout": "Cerrar sesión",
    "register": "Registrarse",
    "email": "Correo electrónico",
    "password": "Contraseña",
    "forgotPassword": "¿Olvidaste tu contraseña?",
    "rememberMe": "Recuérdame",
    "loginSuccess": "Sesión iniciada correctamente",
    "loginError": "Credenciales inválidas",
    "dontHaveAccount": "¿No tienes una cuenta?",
    "alreadyHaveAccount": "¿Ya tienes una cuenta?"
  },
  "validation": {
    "required": "Este campo es obligatorio",
    "emailInvalid": "Correo electrónico inválido",
    "passwordMin": "La contraseña debe tener al menos {min} caracteres",
    "passwordMatch": "Las contraseñas deben coincidir"
  }
}
```

## Usage in Components

### Functional Components

```typescript
import { useTranslation } from 'react-i18next';

export function LoginScreen() {
  const { t } = useTranslation('auth');

  return (
    <View>
      <Text>{t('login')}</Text>
      <Text>{t('email')}</Text>
      <Button title={t('login')} onPress={handleLogin} />
    </View>
  );
}
```

### Namespace Usage

```typescript
// Using specific namespace
const { t } = useTranslation('auth');

// Using default namespace
const { t } = useTranslation();

// Access other namespaces
t('common:save');
t('dashboard:welcome');
```

### With Parameters

```typescript
const { t } = useTranslation('validation');

// Message: "Password must be at least 8 characters"
<Text>{t('passwordMin', { min: 8 })}</Text>

// Multiple parameters
<Text>{t('greeting', { name: 'John', time: 'morning' })}</Text>
```

## Language Switcher

**File:** `mobile/src/shared/components/LanguageSwitcher.tsx`

```typescript
import { useTranslation } from 'react-i18next';
import { View, TouchableOpacity, Text, StyleSheet } from 'react-native';
import { SUPPORTED_LANGUAGES } from '@/shared/i18n/config';
import * as SecureStore from 'expo-secure-store';
import { STORAGE_KEYS } from '@/constants';

export function LanguageSwitcher() {
  const { i18n } = useTranslation();

  const changeLanguage = async (lng: string) => {
    await i18n.changeLanguage(lng);
    await SecureStore.setItemAsync(STORAGE_KEYS.LANGUAGE, lng);
  };

  return (
    <View style={styles.container}>
      {SUPPORTED_LANGUAGES.map((lang) => (
        <TouchableOpacity
          key={lang}
          style={[
            styles.button,
            i18n.language === lang && styles.activeButton,
          ]}
          onPress={() => changeLanguage(lang)}
        >
          <Text
            style={[
              styles.text,
              i18n.language === lang && styles.activeText,
            ]}
          >
            {lang.toUpperCase()}
          </Text>
        </TouchableOpacity>
      ))}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    backgroundColor: '#F2F2F7',
    borderRadius: 8,
    padding: 4,
  },
  button: {
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 6,
  },
  activeButton: {
    backgroundColor: '#FFFFFF',
  },
  text: {
    fontSize: 14,
    color: '#666666',
  },
  activeText: {
    color: '#000000',
    fontWeight: '600',
  },
});
```

## Date & Time Formatting

```typescript
import { useTranslation } from 'react-i18next';
import { format, formatDistanceToNow } from 'date-fns';
import { enGB, es } from 'date-fns/locale';

export function formatDate(date: Date | string) {
  const { i18n } = useTranslation();
  const locale = i18n.language === 'es' ? es : enGB;

  const dateObj = typeof date === 'string' ? new Date(date) : date;

  return format(dateObj, 'PPP', { locale });
}

// Relative time
export function formatRelativeTime(date: Date | string) {
  const { i18n } = useTranslation();
  const locale = i18n.language === 'es' ? es : enGB;

  const dateObj = typeof date === 'string' ? new Date(date) : date;

  return formatDistanceToNow(dateObj, { addSuffix: true, locale });
}
```

## Plurals

**Translation file:**
```json
{
  "items": {
    "count": {
      "zero": "No items",
      "one": "1 item",
      "other": "{{count}} items"
    }
  }
}
```

**Usage:**
```typescript
const { t } = useTranslation('items');

<Text>{t('count', { count: 0 })}</Text>  // "No items"
<Text>{t('count', { count: 1 })}</Text>  // "1 item"
<Text>{t('count', { count: 5 })}</Text>  // "5 items"
```

## Hook for Language

**File:** `mobile/src/shared/hooks/useLanguage.ts`

```typescript
import { useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import * as SecureStore from 'expo-secure-store';
import { STORAGE_KEYS } from '@/constants';
import { SUPPORTED_LANGUAGES } from '@/shared/i18n/config';

export function useLanguage() {
  const { i18n } = useTranslation();

  const changeLanguage = useCallback(async (lng: (typeof SUPPORTED_LANGUAGES)[number]) => {
    await i18n.changeLanguage(lng);
    await SecureStore.setItemAsync(STORAGE_KEYS.LANGUAGE, lng);
  }, [i18n]);

  const getCurrentLanguage = useCallback(() => {
    return i18n.language;
  }, [i18n]);

  return {
    currentLanguage: getCurrentLanguage(),
    changeLanguage,
    supportedLanguages: SUPPORTED_LANGUAGES,
  };
}
```

## Best Practices

### ✅ DO

- Organize translations by namespace (common, dashboard, settings)
- Use nested keys for organization
- Provide all translations from the start
- Use parameters for dynamic content
- Keep translations in JSON files
- Test with different locales
- Format dates/numbers with locale awareness
- Store language preference persistently

### ❌ DON'T

- Hardcode text in components
- Mix languages in one file
- Concatenate translated strings
- Forget to handle plurals
- Skip locale in routing
- Duplicate translation logic
