# Plan: Sistema de Internacionalización (i18n) para Mobile App

**Fecha:** 2026-01-09
**Estado:** Diseño aprobado

## Objetivo

Implementar un sistema completo de internacionalización (i18n) en la app mobile React Native con Expo Router que sea:
- **Escalable**: Fácil agregar nuevos idiomas
- **Mantenible**: Organización clara por namespaces
- **Type-safe**: Autocomplete y validación de keys en TypeScript
- **Performante**: Uso de MMKV para persistencia síncrona

## Stack Tecnológico

- **i18next**: Core del sistema de traducciones
- **react-i18next**: Integración con React/React Native
- **expo-localization**: Detección del idioma del dispositivo
- **MMKV**: Persistencia síncrona de preferencia de idioma
- **TypeScript**: Type-safety completo con autocomplete

## Idiomas

### Iniciales
- Español (es) - idioma por defecto
- Inglés (en)

### Estrategia de crecimiento
Arquitectura preparada para agregar más idiomas fácilmente:
1. Crear carpeta en `locales/{código}`
2. Copiar estructura de namespaces
3. Traducir archivos JSON
4. Actualizar tipo `Language` en hooks

## Arquitectura de Archivos

```
mobile/src/
├── shared/
│   ├── i18n/
│   │   ├── config.ts           # Configuración i18next
│   │   ├── types.ts            # Tipos TypeScript
│   │   ├── storage.ts          # Plugin MMKV
│   │   └── index.ts            # Exports
│   │
│   ├── locales/                # Traducciones por namespace
│   │   ├── en/
│   │   │   ├── common.json     # Botones, labels, errores comunes
│   │   │   ├── auth.json       # Login, registro
│   │   │   ├── dashboard.json  # Dashboard
│   │   │   └── settings.json   # Configuración
│   │   └── es/
│   │       ├── common.json
│   │       ├── auth.json
│   │       ├── dashboard.json
│   │       └── settings.json
│   │
│   ├── hooks/
│   │   ├── useLanguage.ts      # Hook para cambio de idioma
│   │   └── index.ts
│   │
│   └── components/
│       └── LanguageSwitcher.tsx # UI selector de idioma
│
├── app/
│   ├── providers.tsx           # Inicialización de i18n
│   └── +html.tsx               # Import de config (SSR web)
│
└── constants/
    └── index.ts                # STORAGE_KEYS.LANGUAGE
```

## Organización de Traducciones

### Estrategia: Por Namespaces/Features

**Ventajas:**
- Archivos más pequeños y manejables
- Fácil encontrar traducciones
- Escalabilidad para features grandes
- Carga modular por namespace

### Namespaces Iniciales

**common.json** - Elementos compartidos
```json
{
  "buttons": { "save", "cancel", "delete", "edit", "confirm", "back" },
  "labels": { "email", "password", "loading", "error", "success" },
  "errors": { "required", "invalid_email", "network_error" }
}
```

**auth.json** - Autenticación
```json
{
  "login": { "title", "subtitle", "button", "forgot_password", ... },
  "register": { "title", "subtitle", "button", ... }
}
```

**dashboard.json** - Dashboard específico
```json
{
  "title", "welcome", "stats", ...
}
```

**settings.json** - Configuración
```json
{
  "title", "account", "preferences", "about", ...
}
```

## Detección y Persistencia de Idioma

### Flujo de Detección

1. **Primera apertura de la app:**
   - Detectar idioma del dispositivo con `expo-localization`
   - Si el idioma está soportado (en/es) → usar ese
   - Si no está soportado → fallback a español
   - Guardar en MMKV

2. **Usuario cambia idioma manualmente:**
   - Cambiar idioma en i18next
   - Guardar preferencia en MMKV (síncrono)
   - Usar preferencia guardada en futuras aperturas

3. **Aperturas posteriores:**
   - Leer idioma de MMKV (síncrono, instantáneo)
   - Si no existe preferencia → detectar del dispositivo
   - Fallback a español

### Persistencia con MMKV

**Ventajas de MMKV vs AsyncStorage:**
- ✅ Operaciones síncronas (sin await)
- ✅ Más rápido (hasta 30x)
- ✅ Ya implementado en el proyecto
- ✅ Mismo patrón que theme preference

**Ubicación:** `STORAGE_KEYS.LANGUAGE` en MMKV general storage

## TypeScript Type-Safety

### Autocomplete Completo

Mediante module augmentation de i18next:

```typescript
// src/shared/i18n/types.ts
import 'i18next';
import type commonEN from '@shared/locales/en/common.json';
import type authEN from '@shared/locales/en/auth.json';
import type dashboardEN from '@shared/locales/en/dashboard.json';
import type settingsEN from '@shared/locales/en/settings.json';

declare module 'i18next' {
  interface CustomTypeOptions {
    defaultNS: 'common';
    resources: {
      common: typeof commonEN;
      auth: typeof authEN;
      dashboard: typeof dashboardEN;
      settings: typeof settingsEN;
    };
  }
}
```

### Resultado

```typescript
// ✅ Autocomplete funciona
t('common:buttons.save')
t('auth:login.title')

// ❌ Error de TypeScript en desarrollo
t('auth:login.invalid_key')  // Property 'invalid_key' does not exist
```

## Componentes Clave

### 1. Plugin MMKV Storage (src/shared/i18n/storage.ts)

**Propósito:** Integrar MMKV con i18next para persistencia síncrona

```typescript
import { storage } from '@shared/utils/storage';
import { STORAGE_KEYS } from '@constants';
import { getLocales } from 'expo-localization';

export const mmkvLanguageDetector = {
  type: 'languageDetector' as const,
  async: false,
  init: () => {},
  detect: () => {
    // 1. Intentar MMKV primero
    const savedLanguage = storage.getString(STORAGE_KEYS.LANGUAGE);
    if (savedLanguage) return savedLanguage;

    // 2. Detectar del dispositivo
    const deviceLocale = getLocales()[0]?.languageCode || 'es';
    const supportedLanguages = ['en', 'es'];

    return supportedLanguages.includes(deviceLocale) ? deviceLocale : 'es';
  },
  cacheUserLanguage: (language: string) => {
    storage.set(STORAGE_KEYS.LANGUAGE, language);
  },
};
```

### 2. Configuración i18next (src/shared/i18n/config.ts)

**Propósito:** Inicializar i18next con todas las traducciones

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import { mmkvLanguageDetector } from './storage';

// Imports síncronos (mejor para mobile)
import commonEN from '@shared/locales/en/common.json';
import authEN from '@shared/locales/en/auth.json';
import dashboardEN from '@shared/locales/en/dashboard.json';
import settingsEN from '@shared/locales/en/settings.json';

import commonES from '@shared/locales/es/common.json';
import authES from '@shared/locales/es/auth.json';
import dashboardES from '@shared/locales/es/dashboard.json';
import settingsES from '@shared/locales/es/settings.json';

const resources = {
  en: {
    common: commonEN,
    auth: authEN,
    dashboard: dashboardEN,
    settings: settingsEN,
  },
  es: {
    common: commonES,
    auth: authES,
    dashboard: dashboardES,
    settings: settingsES,
  },
};

i18n
  .use(mmkvLanguageDetector)
  .use(initReactI18next)
  .init({
    resources,
    fallbackLng: 'es',
    defaultNS: 'common',
    ns: ['common', 'auth', 'dashboard', 'settings'],
    interpolation: {
      escapeValue: false, // React ya escapa
    },
    react: {
      useSuspense: false, // Importante para React Native
    },
    compatibilityJSON: 'v3', // Para Android
  });

export default i18n;
```

**Notas importantes:**
- `useSuspense: false` - evita problemas en React Native
- `compatibilityJSON: 'v3'` - compatibilidad con Android
- Carga síncrona (no lazy loading) - mejor rendimiento en mobile

### 3. Hook useLanguage (src/shared/hooks/useLanguage.ts)

**Propósito:** API limpia para cambiar idioma

```typescript
import { useTranslation } from 'react-i18next';
import { getLocales } from 'expo-localization';

export type Language = 'en' | 'es';

export function useLanguage() {
  const { i18n } = useTranslation();

  const currentLanguage = i18n.language as Language;

  const changeLanguage = async (language: Language) => {
    await i18n.changeLanguage(language);
  };

  const deviceLanguage = getLocales()[0]?.languageCode as Language || 'es';

  return {
    currentLanguage,
    changeLanguage,
    deviceLanguage,
    isEnglish: currentLanguage === 'en',
    isSpanish: currentLanguage === 'es',
  };
}
```

### 4. Componente LanguageSwitcher (src/shared/components/LanguageSwitcher.tsx)

**Propósito:** UI para cambiar idioma (dos variantes)

**Características:**
- Variante `toggle`: botón simple que alterna entre idiomas
- Variante `selector`: opciones completas con radio buttons
- Diseño consistente con ThemeSwitcher (mismo patrón)
- Persistencia automática en MMKV
- Iconos de banderas para identificación visual

## Integración en la App

### 1. Providers (src/app/providers.tsx)

```typescript
import '@shared/i18n/config'; // ← Inicializar i18n al inicio

export default function Providers({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthInitializer>{children}</AuthInitializer>
    </QueryClientProvider>
  );
}
```

**Importante:** El import debe ser al inicio del archivo, antes del componente.

### 2. Constants (src/constants/index.ts)

```typescript
export const STORAGE_KEYS = {
  ACCESS_TOKEN: 'access_token',
  REFRESH_TOKEN: 'refresh_token',
  USER: 'user',
  THEME: 'theme',
  LANGUAGE: 'language', // ← NUEVO
  ONBOARDING_COMPLETED: 'onboarding_completed',
} as const;
```

### 3. Exports de Hooks (src/shared/hooks/index.ts)

```typescript
export { useTheme } from "./useTheme";
export type { ThemeMode } from "./useTheme";
export { useLanguage } from "./useLanguage";
export type { Language } from "./useLanguage";
```

## Uso en Componentes

### Caso 1: Namespace específico

```typescript
import { useTranslation } from 'react-i18next';

function LoginScreen() {
  const { t } = useTranslation('auth');

  return (
    <View>
      <Text variant="h1">{t('login.title')}</Text>
      <Text variant="body">{t('login.subtitle')}</Text>
      <Button>{t('login.button')}</Button>
    </View>
  );
}
```

### Caso 2: Namespace común

```typescript
import { useTranslation } from 'react-i18next';

function SaveButton() {
  const { t } = useTranslation('common');

  return <Button>{t('buttons.save')}</Button>;
}
```

### Caso 3: Múltiples namespaces

```typescript
function ComplexComponent() {
  const { t } = useTranslation(['auth', 'common']);

  return (
    <View>
      <Text>{t('auth:login.title')}</Text>
      <Button>{t('common:buttons.save')}</Button>
    </View>
  );
}
```

### Caso 4: Con interpolación

```typescript
// JSON: "welcome": "Bienvenido, {{name}}"
const { t } = useTranslation();
<Text>{t('welcome', { name: user.firstName })}</Text>
```

### Caso 5: Pluralización

```typescript
// JSON:
// "items": "{{count}} elemento",
// "items_plural": "{{count}} elementos"

<Text>{t('items', { count: 1 })}</Text>  // "1 elemento"
<Text>{t('items', { count: 5 })}</Text>  // "5 elementos"
```

## Ejemplos de Archivos de Traducción

### common.json (ES)

```json
{
  "buttons": {
    "save": "Guardar",
    "cancel": "Cancelar",
    "delete": "Eliminar",
    "edit": "Editar",
    "confirm": "Confirmar",
    "back": "Volver"
  },
  "labels": {
    "email": "Correo electrónico",
    "password": "Contraseña",
    "loading": "Cargando...",
    "error": "Error",
    "success": "Éxito"
  },
  "errors": {
    "required": "Este campo es requerido",
    "invalid_email": "Correo electrónico inválido",
    "network_error": "Error de conexión"
  }
}
```

### common.json (EN)

```json
{
  "buttons": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "confirm": "Confirm",
    "back": "Back"
  },
  "labels": {
    "email": "Email",
    "password": "Password",
    "loading": "Loading...",
    "error": "Error",
    "success": "Success"
  },
  "errors": {
    "required": "This field is required",
    "invalid_email": "Invalid email",
    "network_error": "Connection error"
  }
}
```

### auth.json (ES)

```json
{
  "login": {
    "title": "Iniciar Sesión",
    "subtitle": "Ingresa tus credenciales",
    "button": "Entrar",
    "forgot_password": "¿Olvidaste tu contraseña?",
    "no_account": "¿No tienes cuenta?",
    "sign_up": "Regístrate"
  },
  "register": {
    "title": "Crear Cuenta",
    "subtitle": "Completa tus datos",
    "button": "Registrarse",
    "have_account": "¿Ya tienes cuenta?",
    "sign_in": "Inicia sesión"
  }
}
```

### auth.json (EN)

```json
{
  "login": {
    "title": "Sign In",
    "subtitle": "Enter your credentials",
    "button": "Login",
    "forgot_password": "Forgot your password?",
    "no_account": "Don't have an account?",
    "sign_up": "Sign up"
  },
  "register": {
    "title": "Create Account",
    "subtitle": "Fill in your details",
    "button": "Register",
    "have_account": "Already have an account?",
    "sign_in": "Sign in"
  }
}
```

## Dependencias a Instalar

```bash
npm install i18next react-i18next expo-localization
```

**Opcional (para extracción automática de keys):**
```bash
npm install -D i18next-parser
```

## Ventajas del Sistema

### Escalabilidad
- ✅ Agregar nuevo idioma: crear carpeta + JSON
- ✅ Agregar namespace: crear JSON en todos los idiomas
- ✅ Estructura clara y predecible

### Mantenibilidad
- ✅ Traducciones organizadas por features
- ✅ Archivos JSON pequeños y manejables
- ✅ Fácil encontrar y actualizar traducciones
- ✅ Separación clara de responsabilidades

### Developer Experience
- ✅ Autocomplete completo en VSCode
- ✅ Type-checking de translation keys
- ✅ Errores de typos detectados en desarrollo
- ✅ Refactoring seguro
- ✅ API limpia y consistente

### Performance
- ✅ MMKV síncrono (sin async/await)
- ✅ Carga síncrona de traducciones (no lazy)
- ✅ Sin suspense (mejor para React Native)
- ✅ Detección de idioma instantánea

### Consistencia
- ✅ Mismo patrón que useTheme
- ✅ Mismo sistema de storage (MMKV)
- ✅ Mismo estilo de componentes (ThemeSwitcher/LanguageSwitcher)
- ✅ Integración limpia con arquitectura existente

## Notas de Implementación

### Orden de Inicialización
1. MMKV ya inicializado (ya existe en el proyecto)
2. i18n se inicializa en import de `providers.tsx`
3. Detección automática de idioma en primer arranque
4. React Query y Auth se inicializan después

### Compatibilidad
- ✅ React Native (iOS/Android)
- ✅ Expo Router
- ✅ TypeScript strict mode
- ✅ Metro bundler
- ⚠️ Web no es prioridad (pero funciona con import en +html.tsx)

### Testing
- Mock de `expo-localization` en tests
- Mock de i18n en componentes
- Tests de detección de idioma
- Tests de persistencia en MMKV

## Próximos Pasos (Post-Implementación)

1. **Migrar screens existentes:**
   - Login/Register screens
   - Dashboard
   - Settings

2. **Agregar LanguageSwitcher en Settings:**
   ```typescript
   <LanguageSwitcher variant="selector" />
   ```

3. **Traducir componentes comunes:**
   - Botones
   - Forms
   - Error messages

4. **Opcional - Extracción automática:**
   - Configurar i18next-parser
   - Script para extraer keys automáticamente
   - Sincronizar con herramientas de traducción

5. **Documentación para agregar idiomas:**
   - Guía paso a paso
   - Template de archivos JSON
   - Checklist de validación

## Referencias

- [i18next Documentation](https://www.i18next.com/)
- [react-i18next Documentation](https://react.i18next.com/)
- [Expo Localization](https://docs.expo.dev/versions/latest/sdk/localization/)
- [MMKV Storage](https://github.com/mrousavy/react-native-mmkv)
